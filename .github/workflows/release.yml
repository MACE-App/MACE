name: Update Appcast on Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.0.8-alpha)'
        required: true

permissions:
  contents: write

jobs:
  update-appcast:
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Sparkle
      run: |
        cd /tmp
        curl -L -o Sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/2.8.1/Sparkle-2.8.1.tar.xz"
        mkdir -p Sparkle
        tar -xf Sparkle.tar.xz -C Sparkle

    - name: Download MACE.zip from release
      env:
        RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
        REPO: ${{ github.repository }}
      run: |
        curl -L -o /tmp/MACE.zip "https://github.com/${REPO}/releases/download/${RELEASE_TAG}/MACE.zip"

    - name: Get file size
      run: |
        SIZE=$(stat -f%z /tmp/MACE.zip 2>/dev/null || stat --printf="%s" /tmp/MACE.zip)
        echo "FILE_SIZE=$SIZE" >> $GITHUB_ENV

    - name: Sign with Sparkle
      env:
        SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
      run: |
        echo "$SPARKLE_PRIVATE_KEY" > /tmp/sparkle_private_key
        SIGN_OUTPUT=$(/tmp/Sparkle/bin/sign_update /tmp/MACE.zip --ed-key-file /tmp/sparkle_private_key)
        echo "Sign output: $SIGN_OUTPUT"
        SIGNATURE=$(echo "$SIGN_OUTPUT" | sed -n 's/.*sparkle:edSignature="\([^"]*\)".*/\1/p')
        echo "Extracted signature: $SIGNATURE"
        echo "SIGNATURE=$SIGNATURE" >> $GITHUB_ENV
        rm /tmp/sparkle_private_key

    - name: Get version info
      env:
        RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
      run: |
        FULL_TAG=$RELEASE_TAG
        echo "FULL_TAG=$FULL_TAG" >> $GITHUB_ENV
        VERSION=${FULL_TAG#v}
        echo "VERSION=$VERSION" >> $GITHUB_ENV

        # Extract build number from version (e.g., 0.0.8-alpha -> 8, 0.1.0-beta -> 10)
        # Use minor*10 + patch for a unique incrementing build number
        BASE_VERSION=$(echo "$VERSION" | sed 's/-.*$//')
        MINOR=$(echo "$BASE_VERSION" | cut -d. -f2)
        PATCH=$(echo "$BASE_VERSION" | cut -d. -f3)
        BUILD_NUM=$((MINOR * 10 + PATCH))
        echo "BUILD_NUM=$BUILD_NUM" >> $GITHUB_ENV
        echo "Calculated build number: $BUILD_NUM from version $VERSION"

        if [[ "$VERSION" == *"-alpha"* ]]; then
          echo "SPARKLE_CHANNEL=alpha" >> $GITHUB_ENV
        elif [[ "$VERSION" == *"-beta"* ]]; then
          echo "SPARKLE_CHANNEL=beta" >> $GITHUB_ENV
        else
          echo "SPARKLE_CHANNEL=" >> $GITHUB_ENV
        fi

    - name: Update appcast.xml
      env:
        REPO: ${{ github.repository }}
      run: |
        DATE=$(date -u "+%a, %d %b %Y %H:%M:%S +0000")
        CHANNEL_LINE=""
        if [[ -n "$SPARKLE_CHANNEL" ]]; then
          CHANNEL_LINE="      <sparkle:channel>$SPARKLE_CHANNEL</sparkle:channel>"
        fi
        {
          echo ""
          echo "    <item>"
          echo "      <title>Version $VERSION</title>"
          echo "      <pubDate>$DATE</pubDate>"
          echo "      <sparkle:version>$BUILD_NUM</sparkle:version>"
          echo "      <sparkle:shortVersionString>$VERSION</sparkle:shortVersionString>"
          echo "      <sparkle:minimumSystemVersion>14.0</sparkle:minimumSystemVersion>"
          if [[ -n "$CHANNEL_LINE" ]]; then
            echo "$CHANNEL_LINE"
          fi
          echo "      <enclosure"
          echo "        url=\"https://github.com/${REPO}/releases/download/$FULL_TAG/MACE.zip\""
          echo "        length=\"$FILE_SIZE\""
          echo "        type=\"application/octet-stream\""
          echo "        sparkle:edSignature=\"$SIGNATURE\""
          echo "      />"
          echo "    </item>"
        } > /tmp/new_item.xml
        sed -i '' "/<language>en<\/language>/r /tmp/new_item.xml" appcast.xml
        echo "=== Updated appcast.xml ==="
        cat appcast.xml

    - name: Commit updated appcast
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add appcast.xml
        git commit -m "Update appcast.xml for $FULL_TAG"
        git push origin HEAD:main
